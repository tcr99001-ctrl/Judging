name: Wipe and Install (Any Zip)

on:
  push:
    paths:
      - '*.zip' # ë£¨íŠ¸ ê²½ë¡œì— zip íŒŒì¼ì´ ì˜¬ë¼ì˜¤ë©´ ë°œë™

jobs:
  wipe-and-install:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Wipe Old Files & Unzip New (Auto Detect)
        run: |
          # 1. í˜„ì¬ ê²½ë¡œì˜ .zip íŒŒì¼ ì°¾ê¸° (ê°€ì¥ ë¨¼ì € ë°œê²¬ëœ ê²ƒ í•˜ë‚˜)
          ZIP_FILE=$(ls *.zip 2>/dev/null | head -n 1)

          if [ -n "$ZIP_FILE" ]; then
            echo "ğŸš¨ ì••ì¶• íŒŒì¼ ê°ì§€ë¨: '$ZIP_FILE'"
            echo "ê¸°ì¡´ íŒŒì¼ ì‚­ì œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."

            # 2. ê¸°ì¡´ íŒŒì¼ ì‚­ì œ (.git, .github, ê·¸ë¦¬ê³  ë°©ê¸ˆ ì°¾ì€ zip íŒŒì¼ ì œì™¸)
            # ì£¼ì˜: $ZIP_FILE ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ zip íŒŒì¼ì´ ì‚­ì œë˜ì§€ ì•Šë„ë¡ í•¨
            find . -maxdepth 1 ! -name '.git' ! -name '.github' ! -name "$ZIP_FILE" ! -name '.' -exec rm -rf {} +
            echo "ğŸ§¹ ì²­ì†Œ ì™„ë£Œ."

            # 3. ì„ì‹œ í´ë”ì— ì••ì¶• í•´ì œ
            echo "ğŸ“¦ '$ZIP_FILE' ì••ì¶• í•´ì œ ì¤‘..."
            mkdir temp_unzip
            unzip -q -o "$ZIP_FILE" -d temp_unzip

            # 4. í´ë” êµ¬ì¡° í‰íƒ„í™” (Flatten) ë¡œì§
            COUNT=$(ls -1 temp_unzip | wc -l)
            FIRST_ITEM=$(ls -1 temp_unzip | head -n 1)
            shopt -s dotglob # ìˆ¨ê¹€ íŒŒì¼ í¬í•¨

            if [ "$COUNT" -eq 1 ] && [ -d "temp_unzip/$FIRST_ITEM" ]; then
              echo "ğŸ“‚ í´ë” ì±„ë¡œ ì••ì¶•ë˜ì—ˆêµ°ìš”. ë‚´ë¶€ íŒŒì¼ì„ êº¼ëƒ…ë‹ˆë‹¤..."
              mv temp_unzip/"$FIRST_ITEM"/* .
            else
              echo "ğŸ“„ íŒŒì¼ë“¤ì´ ë°”ë¡œ ì••ì¶•ë˜ì–´ ìˆêµ°ìš”. ê·¸ëŒ€ë¡œ ì´ë™í•©ë‹ˆë‹¤..."
              mv temp_unzip/* .
            fi

            # 5. ì •ë¦¬
            shopt -u dotglob
            rm -rf temp_unzip
            rm "$ZIP_FILE" # ë‹¤ ì“´ zip íŒŒì¼ ì‚­ì œ
            
            echo "âœ¨ ë°°ì¹˜ ì™„ë£Œ."
          else
            echo "âŒ Zip íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í•˜ìœ„ í´ë”ê°€ ì•„ë‹Œ ë£¨íŠ¸ì— ì˜¬ë ¤ì£¼ì„¸ìš”)"
            exit 1
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          git add -A
          
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Reset & Update: $ZIP_FILE ì ìš© ì™„ë£Œ"
            git push origin HEAD:${{ github.ref }}
            echo "âœ… ì„±ê³µì ìœ¼ë¡œ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          fi
